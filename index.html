<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五度圏 - HPS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            color: #2e7d32;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .main-container {
            display: flex;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .left-panel {
            flex-shrink: 0;
        }

        .circle-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        svg {
            display: block;
        }

        .segment-major {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .segment-major:hover {
            opacity: 0.8;
        }

        .segment-minor {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .segment-minor:hover {
            opacity: 0.8;
        }

        .selected {
            stroke: #ff6f00;
            stroke-width: 4;
        }

        .info-panel {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            width: 700px;
        }

        .info-panel h2 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .info-panel p {
            color: #555;
            font-size: 1.1em;
            margin: 8px 0;
        }

        .right-panel {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            min-width: 500px;
        }

        .right-panel h2 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .progression-selector {
            margin-bottom: 30px;
        }

        .progression-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #2e7d32;
        }

        .progression-selector select {
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            border: 2px solid #81c784;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .progression-display {
            margin-bottom: 30px;
        }

        .progression-summary {
            background: #f1f8e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progression-summary h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .progression-summary p {
            font-size: 1.2em;
            color: #555;
            margin: 5px 0;
        }

        .progression-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .progression-table th,
        .progression-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .progression-table th {
            background: #2e7d32;
            color: white;
            font-weight: bold;
        }

        .progression-table tr:hover {
            background: #f5f5f5;
        }

        .progression-table td {
            color: #333;
        }

        .function-tonic {
            color: #ff9800;
            font-weight: bold;
        }

        .function-subdominant {
            color: #42a5f5;
            font-weight: bold;
        }

        .function-dominant {
            color: #ef5350;
            font-weight: bold;
        }

        .degree-circle {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .degree-circle:hover {
            transform: scale(1.1);
        }

        text {
            user-select: none;
        }

        .placeholder-message {
            text-align: center;
            color: #999;
            font-size: 1.1em;
            padding: 40px;
        }
    </style>
</head>
<body>
    <h1>五度圏 (Circle of Fifths)</h1>

    <div class="main-container">
        <div class="left-panel">
            <div class="circle-container">
                <svg width="700" height="700" id="circle-of-fifths">
                    <!-- SVGはJavaScriptで生成 -->
                </svg>
            </div>

            <div class="info-panel">
                <h2>キーを選択してください</h2>
                <p>長調（外側）または短調（中間）のセグメントをクリックすると、詳細情報が表示されます。</p>
            </div>
        </div>

        <div class="right-panel">
            <h2>よくあるコード進行</h2>

            <div class="progression-selector">
                <label for="progression-select">進行を選択:</label>
                <select id="progression-select">
                    <option value="">-- キーを選択してください --</option>
                </select>
            </div>

            <div id="progression-content" class="progression-display">
                <div class="placeholder-message">
                    キーとコード進行を選択してください
                </div>
            </div>
        </div>
    </div>

    <script>
        // 五度圏の12キー（12時の位置から時計回り）
        const keys = [
            { major: 'C', minor: 'Am', sharps: 0, flats: 0 },
            { major: 'G', minor: 'Em', sharps: 1, flats: 0 },
            { major: 'D', minor: 'Bm', sharps: 2, flats: 0 },
            { major: 'A', minor: 'F♯m', sharps: 3, flats: 0 },
            { major: 'E', minor: 'C♯m', sharps: 4, flats: 0 },
            { major: 'B', minor: 'G♯m', sharps: 5, flats: 0 },
            { major: 'G♭', minor: 'E♭m', sharps: 0, flats: 6 },
            { major: 'D♭', minor: 'B♭m', sharps: 0, flats: 5 },
            { major: 'A♭', minor: 'Fm', sharps: 0, flats: 4 },
            { major: 'E♭', minor: 'Cm', sharps: 0, flats: 3 },
            { major: 'B♭', minor: 'Gm', sharps: 0, flats: 2 },
            { major: 'F', minor: 'Dm', sharps: 0, flats: 1 }
        ];

        // 音名の配列（五度圏順、♯系/♭系の両方）
        const noteNames = [
            { sharp: 'C', flat: 'C' },
            { sharp: 'G', flat: 'G' },
            { sharp: 'D', flat: 'D' },
            { sharp: 'A', flat: 'A' },
            { sharp: 'E', flat: 'E' },
            { sharp: 'B', flat: 'B' },
            { sharp: 'F♯', flat: 'G♭' },
            { sharp: 'C♯', flat: 'D♭' },
            { sharp: 'G♯', flat: 'A♭' },
            { sharp: 'D♯', flat: 'E♭' },
            { sharp: 'A♯', flat: 'B♭' },
            { sharp: 'F', flat: 'F' }
        ];

        // 音名を取得する関数（キーに応じて♯系/♭系を選択）
        function getNoteName(index, useSharp) {
            const note = noteNames[index];
            return useSharp ? note.sharp : note.flat;
        }

        // 機能ごとの色定義
        const TONIC_COLOR = '#ff9800';        // トニック系：オレンジ
        const SUBDOMINANT_COLOR = '#42a5f5';  // サブドミナント系：ブルー
        const DOMINANT_COLOR = '#ef5350';     // ドミナント系：レッド

        // ダイアトニックコードのディグリー（五度圏上のオフセット）
        const majorDegrees = [
            { roman: 'I', offset: 0, suffix: 'Maj7', function: 'トニック', isMajor: true, color: TONIC_COLOR },
            { roman: 'I', offset: 0, suffix: '7', function: 'セカンダリー・ドミナント (V7/IV)', isMajor: true, color: DOMINANT_COLOR },
            { roman: 'ii', offset: 2, suffix: 'm7', function: 'サブドミナント', isMajor: false, color: SUBDOMINANT_COLOR },
            { roman: 'iii', offset: 4, suffix: 'm7', function: 'トニック（代理）', isMajor: false, color: TONIC_COLOR },
            { roman: 'IV', offset: -1, suffix: 'Maj7', function: 'サブドミナント', isMajor: true, color: SUBDOMINANT_COLOR },
            { roman: 'IV', offset: -1, suffix: 'm7', function: 'サブドミナント・マイナー', isMajor: false, color: SUBDOMINANT_COLOR },
            { roman: 'V', offset: 1, suffix: '7', function: 'ドミナント', isMajor: true, color: DOMINANT_COLOR },
            { roman: 'vi', offset: 3, suffix: 'm7', function: 'トニック（代理）', isMajor: false, color: TONIC_COLOR },
            { roman: 'vii°', offset: 5, suffix: 'm7(♭5)', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR },
            { roman: 'bVII', offset: -2, suffix: 'Maj7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR }
        ];

        const minorDegrees = [
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm7', function: 'トニック', isMajor: false, color: TONIC_COLOR },
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm(Maj7)', function: 'トニック', isMajor: false, color: TONIC_COLOR },
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm6', function: 'トニック', isMajor: false, color: TONIC_COLOR },
            { roman: 'ii', offset: 2, circleOffset: 2, suffix: 'm7(♭5)', function: 'サブドミナント（代理）', isMajor: false, color: SUBDOMINANT_COLOR },
            { roman: 'bIII', offset: -3, circleOffset: 0, suffix: 'Maj7', function: 'トニック（代理）', isMajor: true, color: TONIC_COLOR },
            { roman: 'iv', offset: -1, circleOffset: -1, suffix: 'm7', function: 'サブドミナント', isMajor: false, color: SUBDOMINANT_COLOR },
            { roman: 'V', offset: 1, circleOffset: 1, suffix: '7', function: 'ドミナント（ハーモニック）', isMajor: true, color: DOMINANT_COLOR },
            { roman: 'v', offset: 1, circleOffset: 1, suffix: 'm7', function: 'ドミナント（ナチュラル）', isMajor: false, color: DOMINANT_COLOR },
            { roman: 'bVI', offset: -4, circleOffset: -1, suffix: 'Maj7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR },
            { roman: 'VII', offset: 5, circleOffset: 5, suffix: 'dim7', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR },
            { roman: 'bVII', offset: -2, circleOffset: 1, suffix: 'Maj7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR },
            { roman: 'bVII', offset: -2, circleOffset: 1, suffix: '7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR },
            { roman: 'I', offset: 0, circleOffset: 0, suffix: '7', function: 'セカンダリー・ドミナント (V7/IV)', isMajor: true, color: DOMINANT_COLOR }
        ];

        // よくあるコード進行のプリセット（メジャー・キー）
        const majorProgressions = {
            '251': { name: 'ツーファイブワン (II-V-I)', degrees: ['iim7', 'V7', 'IMaj7'] },
            '1645_50s': { name: '50s進行 (I-VI-IV-V)', degrees: ['IMaj7', 'vim7', 'IVMaj7', 'V7'] },
            '1564': { name: '王道進行 (I-V-VI-IV)', degrees: ['IMaj7', 'V7', 'vim7', 'IVMaj7'] },
            '4516': { name: '王道進行バリエ (IV-V-I-VI)', degrees: ['IVMaj7', 'V7', 'IMaj7', 'vim7'] },
            '4m-4-1-I7': { name: 'サブドミナント・マイナー進行 (IV-IVm-I-I7)', degrees: ['IVMaj7', 'IVm7', 'IMaj7', 'I7'] },
            '1451': { name: 'スリーコード (I-IV-V-I)', degrees: ['IMaj7', 'IVMaj7', 'V7', 'IMaj7'] },
            '1625': { name: '1625進行 (I-VI-II-V)', degrees: ['IMaj7', 'vim7', 'iim7', 'V7'] },
            '4536': { name: 'IV-V-III-VI', degrees: ['IVMaj7', 'V7', 'iiim7', 'vim7'] },
            '1345': { name: 'I-III-IV-V', degrees: ['IMaj7', 'iiim7', 'IVMaj7', 'V7'] },
            '1b741': { name: 'I-bVII-IV-I', degrees: ['IMaj7', 'bVIIMaj7', 'IVMaj7', 'IMaj7'] }
        };

        // よくあるコード進行のプリセット（マイナー・キー）
        const minorProgressions = {
            'm251': { name: 'マイナー・ツーファイブワン (IIm7♭5-V7-Im)', degrees: ['iim7(♭5)', 'V7', 'im7'] },
            'mblues': { name: 'マイナー・ブルース (Im-IVm-V7-Im)', degrees: ['im7', 'ivm7', 'V7', 'im7'] },
            'cliche': { name: 'マイナー・ライン・クリシェ', degrees: ['im7', 'im(Maj7)', 'im7', 'im6'] },
            'secondary': { name: 'セカンダリー・ドミナント (Im-I7-IVm-V7)', degrees: ['im7', 'I7', 'ivm7', 'V7'] },
            'harmonic': { name: 'ハーモニック・マイナー進行 (Im-bVI-V7-Im)', degrees: ['im7', 'bVIMaj7', 'V7', 'im7'] },
            'relative': { name: 'リラティブ・メジャーへ (IIm7♭5-V7-Im-bIII)', degrees: ['iim7(♭5)', 'V7', 'im7', 'bIIIMaj7'] },
            'dim': { name: 'ディミニッシュ・アプローチ (Im-VIIdim-V7-Im)', degrees: ['im7', 'VIIdim7', 'V7', 'im7'] },
            'natural': { name: 'ナチュラルマイナー系 (Im-IVm-bVII-bIII)', degrees: ['im7', 'ivm7', 'bVII7', 'bIIIMaj7'] },
            'prep251': { name: 'ツーファイブへの準備 (Im-bVI-IIm7♭5-V7)', degrees: ['im7', 'bVIMaj7', 'iim7(♭5)', 'V7'] },
            'royal_minor': { name: '王道進行マイナー版 (bVI-bVII-Im-V7)', degrees: ['bVIMaj7', 'bVII7', 'im7', 'V7'] }
        };

        const svg = document.getElementById('circle-of-fifths');
        const centerX = 350;
        const centerY = 350;
        const outerRadius = 280;
        const innerMajorRadius = 200;
        const innerMinorRadius = 200;
        const centerMinorRadius = 120;
        const degreeCircleRadius = 25;
        const anglePerSegment = 30;

        // 現在の選択状態
        let currentKey = null;
        let currentType = null;
        let currentKeyIndex = null;

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function createSegmentPath(cx, cy, innerR, outerR, startAngle, endAngle) {
            const startOuter = polarToCartesian(cx, cy, outerR, startAngle);
            const endOuter = polarToCartesian(cx, cy, outerR, endAngle);
            const startInner = polarToCartesian(cx, cy, innerR, endAngle);
            const endInner = polarToCartesian(cx, cy, innerR, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

            return [
                "M", startOuter.x, startOuter.y,
                "A", outerR, outerR, 0, largeArcFlag, 1, endOuter.x, endOuter.y,
                "L", startInner.x, startInner.y,
                "A", innerR, innerR, 0, largeArcFlag, 0, endInner.x, endInner.y,
                "Z"
            ].join(" ");
        }

        // 各セグメントを描画
        keys.forEach((key, index) => {
            const startAngle = index * anglePerSegment;
            const endAngle = startAngle + anglePerSegment;
            const midAngle = startAngle + anglePerSegment / 2;

            // 長調セグメント
            const majorPath = createSegmentPath(centerX, centerY, innerMajorRadius, outerRadius, startAngle, endAngle);
            const majorSegment = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            majorSegment.setAttribute('d', majorPath);
            majorSegment.setAttribute('fill', '#388e3c');
            majorSegment.setAttribute('stroke', 'white');
            majorSegment.setAttribute('stroke-width', '2');
            majorSegment.classList.add('segment-major');
            majorSegment.setAttribute('data-key', key.major);
            majorSegment.setAttribute('data-type', 'major');
            majorSegment.setAttribute('data-index', index);
            svg.appendChild(majorSegment);

            // 長調のテキスト
            const majorTextPos = polarToCartesian(centerX, centerY, (outerRadius + innerMajorRadius) / 2, midAngle);
            const majorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            majorText.setAttribute('x', majorTextPos.x);
            majorText.setAttribute('y', majorTextPos.y + 6);
            majorText.setAttribute('text-anchor', 'middle');
            majorText.setAttribute('font-size', '22');
            majorText.setAttribute('font-weight', 'bold');
            majorText.setAttribute('fill', 'white');
            majorText.textContent = key.major;
            svg.appendChild(majorText);

            // 短調セグメント
            const minorPath = createSegmentPath(centerX, centerY, centerMinorRadius, innerMinorRadius, startAngle, endAngle);
            const minorSegment = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            minorSegment.setAttribute('d', minorPath);
            minorSegment.setAttribute('fill', '#81c784');
            minorSegment.setAttribute('stroke', 'white');
            minorSegment.setAttribute('stroke-width', '2');
            minorSegment.classList.add('segment-minor');
            minorSegment.setAttribute('data-key', key.minor);
            minorSegment.setAttribute('data-type', 'minor');
            minorSegment.setAttribute('data-index', index);
            svg.appendChild(minorSegment);

            // 短調のテキスト
            const minorTextPos = polarToCartesian(centerX, centerY, (innerMinorRadius + centerMinorRadius) / 2, midAngle);
            const minorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            minorText.setAttribute('x', minorTextPos.x);
            minorText.setAttribute('y', minorTextPos.y - 8);
            minorText.setAttribute('text-anchor', 'middle');
            minorText.setAttribute('font-size', '16');
            minorText.setAttribute('fill', '#1b5e20');
            minorText.textContent = key.minor;
            svg.appendChild(minorText);

            // クリックイベント
            majorSegment.addEventListener('click', () => selectKey(key, 'major', majorSegment, index));
            minorSegment.addEventListener('click', () => selectKey(key, 'minor', minorSegment, index));
        });

        // 中央の白い円
        const centerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        centerCircle.setAttribute('cx', centerX);
        centerCircle.setAttribute('cy', centerY);
        centerCircle.setAttribute('r', centerMinorRadius);
        centerCircle.setAttribute('fill', 'white');
        svg.appendChild(centerCircle);

        // キー選択
        let selectedElement = null;
        let degreeElements = [];

        function selectKey(key, type, element, index) {
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }

            degreeElements.forEach(el => el.remove());
            degreeElements = [];

            element.classList.add('selected');
            selectedElement = element;

            currentKey = key;
            currentType = type;
            currentKeyIndex = index;

            const selectedIndex = parseInt(element.getAttribute('data-index'));
            const allDegrees = type === 'major' ? majorDegrees : minorDegrees;

            // 五度圏上には基本的なダイアトニックコードのみ表示
            const majorDiatonicOnly = ['IMaj7', 'iim7', 'iiim7', 'IVMaj7', 'V7', 'vim7', 'vii°m7(♭5)'];
            const minorDiatonicOnly = ['im7', 'iim7(♭5)', 'bIIIMaj7', 'ivm7', 'vm7', 'bVIMaj7', 'bVIIMaj7'];
            const diatonicOnly = type === 'major' ? majorDiatonicOnly : minorDiatonicOnly;
            const degreesToShow = allDegrees.filter(d => diatonicOnly.includes(d.roman + d.suffix));

            degreesToShow.forEach((degree) => {
                // 五度圏表示用はcircleOffsetを使用（なければoffset）
                const displayOffset = degree.circleOffset !== undefined ? degree.circleOffset : degree.offset;
                let targetIndex = (selectedIndex + displayOffset + 12) % 12;

                if (type === 'major' && !degree.isMajor) {
                    targetIndex = (targetIndex + 9) % 12;
                }

                const startAngle = targetIndex * anglePerSegment;
                const midAngle = startAngle + anglePerSegment / 2;

                let displayRadius;
                if (degree.isMajor) {
                    displayRadius = outerRadius + 30;
                } else {
                    displayRadius = (innerMinorRadius + centerMinorRadius) / 2;
                }

                const pos = polarToCartesian(centerX, centerY, displayRadius, midAngle);

                const degreeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                degreeGroup.classList.add('degree-circle');

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', degree.isMajor ? pos.y : pos.y + 15);
                const circleRadius = degree.isMajor ? degreeCircleRadius : 18;
                circle.setAttribute('r', circleRadius);
                circle.setAttribute('fill', degree.color);
                circle.setAttribute('fill-opacity', degree.isMajor ? '1' : '0.8');
                circle.setAttribute('stroke', 'white');
                circle.setAttribute('stroke-width', '2');

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', pos.x);
                const textY = degree.isMajor ? pos.y + 5 : pos.y + 15 + 4;
                text.setAttribute('y', textY);
                text.setAttribute('text-anchor', 'middle');
                const fontSize = degree.isMajor ? '14' : '10';
                text.setAttribute('font-size', fontSize);
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', degree.color === DOMINANT_COLOR ? 'white' : '#333');
                text.textContent = degree.roman;

                degreeGroup.appendChild(circle);
                degreeGroup.appendChild(text);
                svg.appendChild(degreeGroup);

                degreeElements.push(degreeGroup);
            });

            // 情報パネルを更新
            const infoPanel = document.querySelector('.info-panel');
            const keyName = type === 'major' ? key.major : key.minor;
            const keyType = type === 'major' ? '長調' : '短調';

            let accidentals = '';
            if (key.sharps > 0) {
                accidentals = `♯が${key.sharps}個`;
            } else if (key.flats > 0) {
                accidentals = `♭が${key.flats}個`;
            } else {
                accidentals = '調号なし';
            }

            const parallel = type === 'major' ?
                `平行短調: ${key.minor}` :
                `平行長調: ${key.major}`;

            infoPanel.innerHTML = `
                <h2>${keyName} ${keyType}</h2>
                <p><strong>調号:</strong> ${accidentals}</p>
                <p>${parallel}</p>
                <p style="margin-top: 15px; color: #2e7d32; font-size: 1em;">
                    <strong>ダイアトニックコード:</strong> 五度圏上に表示されています
                </p>
            `;

            updateProgressionSelect();
            updateProgressionDisplay();
        }

        // コード進行セレクトの更新（メジャー/マイナーに応じて）
        function updateProgressionSelect() {
            const progressionSelect = document.getElementById('progression-select');
            const progressions = currentType === 'major' ? majorProgressions : minorProgressions;

            // ドロップダウンを再構築
            progressionSelect.innerHTML = '<option value="">-- 進行を選択してください --</option>';

            Object.keys(progressions).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = progressions[key].name;
                progressionSelect.appendChild(option);
            });

            // 表示をクリア
            const progressionContent = document.getElementById('progression-content');
            progressionContent.innerHTML = `
                <div class="placeholder-message">
                    キーとコード進行を選択してください
                </div>
            `;
        }

        // コード進行パネルの更新
        function updateProgressionDisplay() {
            const progressionSelect = document.getElementById('progression-select');
            const selectedProgression = progressionSelect.value;

            if (!currentKey || !selectedProgression) {
                return;
            }

            const progressions = currentType === 'major' ? majorProgressions : minorProgressions;
            const progression = progressions[selectedProgression];
            const degreesData = currentType === 'major' ? majorDegrees : minorDegrees;

            // キー名から♯系/♭系を判定
            const keyName = currentType === 'major' ? currentKey.major : currentKey.minor;
            const useSharp = !keyName.includes('♭');

            // 進行のディグリーに対応するコード情報を取得
            const chords = progression.degrees.map(degreeRoman => {
                const degreeInfo = degreesData.find(d => (d.roman + d.suffix) === degreeRoman);
                if (!degreeInfo) return null;

                // マイナーキーの場合、トニックの位置（平行調+3）を基準にoffsetを加える
                const baseIndex = currentType === 'minor' ? (currentKeyIndex + 3) % 12 : currentKeyIndex;
                const rootIndex = (baseIndex + degreeInfo.offset + 12) % 12;
                const rootNote = getNoteName(rootIndex, useSharp);
                const chordName = rootNote + degreeInfo.suffix;

                return {
                    degree: degreeInfo.roman + degreeInfo.suffix,
                    function: degreeInfo.function,
                    chord: chordName,
                    notes: rootNote
                };
            }).filter(c => c !== null);

            const chordsString = chords.map(c => c.chord).join(' - ');
            const degreesString = chords.map(c => c.degree).join(' - ');

            const displayKeyName = currentType === 'major' ? currentKey.major : currentKey.minor;

            let tableHTML = `
                <div class="progression-summary">
                    <h3>${progression.name}</h3>
                    <p><strong>ディグリー:</strong> ${degreesString}</p>
                    <p><strong>キー${displayKeyName}:</strong> ${chordsString}</p>
                </div>

                <table class="progression-table">
                    <thead>
                        <tr>
                            <th>ディグリー</th>
                            <th>機能</th>
                            <th>コード</th>
                            <th>根音</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            chords.forEach(chord => {
                let functionClass = '';
                if (chord.function.includes('トニック')) functionClass = 'function-tonic';
                else if (chord.function.includes('サブドミナント')) functionClass = 'function-subdominant';
                else if (chord.function.includes('ドミナント')) functionClass = 'function-dominant';

                tableHTML += `
                    <tr>
                        <td>${chord.degree}</td>
                        <td class="${functionClass}">${chord.function}</td>
                        <td><strong>${chord.chord}</strong></td>
                        <td>${chord.notes}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('progression-content').innerHTML = tableHTML;
        }

        // 進行選択のイベントリスナー
        document.getElementById('progression-select').addEventListener('change', updateProgressionDisplay);
    </script>
</body>
</html>
