<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五度圏 - HPS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
            align-items: stretch;
        }

        .left-panel {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .circle-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        svg {
            display: block;
        }

        .segment-major {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .segment-major:hover {
            opacity: 0.8;
        }

        .segment-minor {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .segment-minor:hover {
            opacity: 0.8;
        }

        .selected {
            stroke: #ff6f00;
            stroke-width: 4;
        }

        .info-panel {
            margin-top: 15px;
            padding: 15px 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            text-align: center;
            flex-grow: 1;
        }

        .info-panel h2 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .info-panel p {
            color: #555;
            font-size: 1em;
            margin: 6px 0;
        }

        /* 中央パネル: ダイアトニックコード */
        .center-panel {
            flex-shrink: 0;
            width: 320px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .center-panel h2 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        /* 右パネル: コード進行 */
        .right-panel {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            min-width: 400px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
        }

        .right-panel h2 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .progression-selector {
            margin-bottom: 20px;
        }

        .progression-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2e7d32;
            font-size: 0.95em;
        }

        .progression-selector select {
            width: 100%;
            padding: 8px;
            font-size: 1em;
            border: 2px solid #81c784;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .progression-display {
            margin-bottom: 20px;
        }

        .progression-summary {
            background: #f1f8e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .progression-summary h3 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .progression-summary p {
            font-size: 1em;
            color: #555;
            margin: 3px 0;
        }

        /* 進行の解説 */
        .progression-description {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ff9800;
        }

        .progression-description h4 {
            color: #e65100;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .progression-description p {
            font-size: 0.9em;
            color: #555;
            line-height: 1.6;
        }

        .progression-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .progression-table th,
        .progression-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
        }

        .progression-table th {
            background: #2e7d32;
            color: white;
            font-weight: bold;
        }

        .progression-table tr:hover {
            background: #f5f5f5;
        }

        .progression-table td {
            color: #333;
        }

        /* ブルース進行の小節表示 */
        .blues-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .blues-bar {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 6px;
            text-align: center;
            font-weight: bold;
            font-size: 0.85em;
        }

        .blues-bar-number {
            font-size: 0.7em;
            color: #999;
            display: block;
            margin-bottom: 4px;
        }

        .function-tonic {
            color: #ff9800;
            font-weight: bold;
        }

        .function-subdominant {
            color: #42a5f5;
            font-weight: bold;
        }

        .function-dominant {
            color: #ef5350;
            font-weight: bold;
        }

        .degree-circle {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .degree-circle:hover {
            transform: scale(1.1);
        }

        text {
            user-select: none;
        }

        .placeholder-message {
            text-align: center;
            color: #999;
            font-size: 1em;
            padding: 30px;
        }

        .diatonic-panel {
            margin-bottom: 15px;
            padding: 12px;
            background: #f1f8e9;
            border-radius: 8px;
        }

        .diatonic-panel h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1em;
        }

        .diatonic-table {
            width: 100%;
            border-collapse: collapse;
        }

        .diatonic-table th,
        .diatonic-table td {
            padding: 5px 6px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.85em;
        }

        .diatonic-table th {
            background: #2e7d32;
            color: white;
            font-weight: bold;
        }

        .diatonic-table tr:hover {
            background: #f5f5f5;
        }

        .diatonic-table td {
            color: #333;
        }

        .diatonic-table td:first-child {
            font-weight: bold;
        }

        /* モバイル用ドットインジケーター */
        .mobile-indicator {
            display: none;
            justify-content: center;
            gap: 12px;
            padding: 15px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-bottom: 15px;
        }

        .mobile-indicator .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #c8e6c9;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-indicator .dot.active {
            background: #2e7d32;
            transform: scale(1.2);
        }

        .mobile-indicator .dot-label {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 4px;
        }

        .dot-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* モバイル用レイアウト */
        @media (max-width: 900px) {
            body {
                flex-direction: column;
                align-items: stretch;
                padding: 10px;
            }

            .mobile-indicator {
                display: flex;
                position: sticky;
                top: 10px;
                z-index: 100;
                width: fit-content;
                margin: 0 auto 15px auto;
            }

            .main-container {
                flex-direction: row;
                overflow-x: scroll;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                gap: 15px;
                width: 100%;
                padding-bottom: 20px;
            }

            .left-panel {
                scroll-snap-align: center;
                min-width: calc(100vw - 30px);
                flex-shrink: 0;
            }

            .center-panel {
                scroll-snap-align: center;
                min-width: calc(100vw - 30px);
                width: calc(100vw - 30px) !important;
            }

            .right-panel {
                scroll-snap-align: center;
                min-width: calc(100vw - 30px);
                max-width: none;
            }

            .circle-container {
                padding: 15px;
                overflow-x: auto;
            }

            svg {
                max-width: 100%;
                height: auto;
            }

            .info-panel {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- モバイル用ドットインジケーター -->
    <div class="mobile-indicator" id="mobile-indicator">
        <div class="dot-wrapper" data-panel="0">
            <div class="dot active"></div>
            <div class="dot-label">五度圏</div>
        </div>
        <div class="dot-wrapper" data-panel="1">
            <div class="dot"></div>
            <div class="dot-label">コード</div>
        </div>
        <div class="dot-wrapper" data-panel="2">
            <div class="dot"></div>
            <div class="dot-label">進行</div>
        </div>
    </div>

    <div class="main-container" id="main-container">
        <!-- 左パネル: 五度圏 -->
        <div class="left-panel">
            <div class="circle-container">
                <svg width="700" height="700" id="circle-of-fifths">
                    <!-- SVGはJavaScriptで生成 -->
                </svg>
            </div>

            <div class="info-panel">
                <h2>キーを選択してください</h2>
                <p>長調（外側）または短調（中間）のセグメントをクリックすると、詳細情報が表示されます。</p>
            </div>
        </div>

        <!-- 中央パネル: ダイアトニックコード -->
        <div class="center-panel" id="center-panel" style="display: none;">
            <h2>ダイアトニックコード</h2>
            <div class="diatonic-panel" id="diatonic-panel">
                <h3 id="diatonic-title">ダイアトニックコード</h3>
                <table class="diatonic-table">
                    <thead>
                        <tr>
                            <th>ディグリー</th>
                            <th>コード名</th>
                            <th>機能</th>
                        </tr>
                    </thead>
                    <tbody id="diatonic-tbody">
                        <!-- JavaScriptで動的に生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 右パネル: コード進行 -->
        <div class="right-panel">
            <h2>よくあるコード進行</h2>

            <div class="progression-selector">
                <label for="progression-select">進行を選択:</label>
                <select id="progression-select">
                    <option value="">-- キーを選択してください --</option>
                </select>
            </div>

            <div id="progression-content" class="progression-display">
                <div class="placeholder-message">
                    キーとコード進行を選択してください
                </div>
            </div>
        </div>
    </div>

    <script>
        // 五度圏の12キー（12時の位置から時計回り）
        const keys = [
            { major: 'C', minor: 'Am', sharps: 0, flats: 0 },
            { major: 'G', minor: 'Em', sharps: 1, flats: 0 },
            { major: 'D', minor: 'Bm', sharps: 2, flats: 0 },
            { major: 'A', minor: 'F♯m', sharps: 3, flats: 0 },
            { major: 'E', minor: 'C♯m', sharps: 4, flats: 0 },
            { major: 'B', minor: 'G♯m', sharps: 5, flats: 0 },
            { major: 'G♭', minor: 'E♭m', sharps: 0, flats: 6 },
            { major: 'D♭', minor: 'B♭m', sharps: 0, flats: 5 },
            { major: 'A♭', minor: 'Fm', sharps: 0, flats: 4 },
            { major: 'E♭', minor: 'Cm', sharps: 0, flats: 3 },
            { major: 'B♭', minor: 'Gm', sharps: 0, flats: 2 },
            { major: 'F', minor: 'Dm', sharps: 0, flats: 1 }
        ];

        // 音名の配列（五度圏順、♯系/♭系の両方）
        const noteNames = [
            { sharp: 'C', flat: 'C' },
            { sharp: 'G', flat: 'G' },
            { sharp: 'D', flat: 'D' },
            { sharp: 'A', flat: 'A' },
            { sharp: 'E', flat: 'E' },
            { sharp: 'B', flat: 'B' },
            { sharp: 'F♯', flat: 'G♭' },
            { sharp: 'C♯', flat: 'D♭' },
            { sharp: 'G♯', flat: 'A♭' },
            { sharp: 'D♯', flat: 'E♭' },
            { sharp: 'A♯', flat: 'B♭' },
            { sharp: 'F', flat: 'F' }
        ];

        // 音名を取得する関数（キーに応じて♯系/♭系を選択）
        function getNoteName(index, useSharp) {
            const note = noteNames[index];
            return useSharp ? note.sharp : note.flat;
        }

        // 機能ごとの色定義
        const TONIC_COLOR = '#ff9800';        // トニック系：オレンジ
        const SUBDOMINANT_COLOR = '#42a5f5';  // サブドミナント系：ブルー
        const DOMINANT_COLOR = '#ef5350';     // ドミナント系：レッド

        // ダイアトニックコードのディグリー（五度圏上のオフセット）
        const majorDegrees = [
            { roman: 'I', offset: 0, suffix: 'Maj7', function: 'トニック', isMajor: true, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'ii', offset: 2, suffix: 'm7', function: 'サブドミナント', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: 'iii', offset: 4, suffix: 'm7', function: 'トニック（代理）', isMajor: false, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'IV', offset: -1, suffix: 'Maj7', function: 'サブドミナント', isMajor: true, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: 'V', offset: 1, suffix: '7', function: 'ドミナント', isMajor: true, color: DOMINANT_COLOR, isDiatonic: true },
            { roman: 'vi', offset: 3, suffix: 'm7', function: 'トニック（代理）', isMajor: false, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'vii', offset: 5, suffix: 'm7(♭5)', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR, isDiatonic: true },
            // ノンダイアトニックだが実用的
            { roman: 'I', offset: 0, suffix: '7', function: 'トニック（ブルース）', isMajor: true, color: TONIC_COLOR, isDiatonic: false },
            { roman: 'IV', offset: -1, suffix: '7', function: 'サブドミナント（ブルース）', isMajor: true, color: SUBDOMINANT_COLOR, isDiatonic: false },
            { roman: 'vii', offset: 5, suffix: 'dim7', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR, isDiatonic: false },
            { roman: '♭II', offset: -5, suffix: '7', function: '裏コード（V7代理）', isMajor: true, color: DOMINANT_COLOR, isDiatonic: false },
            { roman: 'IV', offset: -1, suffix: 'm7', function: 'サブドミナント・マイナー', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: false }
        ];

        // ナチュラルマイナーのダイアトニックコード（実用的なノンダイアトニック含む）
        const minorDegreesNatural = [
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm7', function: 'トニック', isMajor: false, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'ii', offset: 2, circleOffset: 2, suffix: 'm7(♭5)', function: 'サブドミナント（代理）', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: '♭III', offset: -3, circleOffset: 0, suffix: 'Maj7', function: 'トニック（代理）', isMajor: true, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'iv', offset: -1, circleOffset: -1, suffix: 'm7', function: 'サブドミナント', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: 'v', offset: 1, circleOffset: 1, suffix: 'm7', function: 'ドミナント（ナチュラル）', isMajor: false, color: DOMINANT_COLOR, isDiatonic: true },
            { roman: '♭VI', offset: -4, circleOffset: -1, suffix: 'Maj7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: '♭VII', offset: -2, circleOffset: 1, suffix: '7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR, isDiatonic: true },
            // ノンダイアトニックだが実用的
            { roman: 'V', offset: 1, circleOffset: 1, suffix: '7', function: 'ドミナント', isMajor: true, color: DOMINANT_COLOR, isDiatonic: false },
            { roman: 'vii', offset: 5, circleOffset: 5, suffix: 'dim7', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR, isDiatonic: false },
            { roman: '♭II', offset: -5, circleOffset: -5, suffix: '7', function: '裏コード（V7代理）', isMajor: true, color: DOMINANT_COLOR, isDiatonic: false }
        ];

        // ハーモニックマイナーのダイアトニックコード
        const minorDegreesHarmonic = [
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm(Maj7)', function: 'トニック', isMajor: false, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'ii', offset: 2, circleOffset: 2, suffix: 'm7(♭5)', function: 'サブドミナント（代理）', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: '♭III', offset: -3, circleOffset: 0, suffix: 'Maj7(♯5)', function: 'トニック（代理）', isMajor: true, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'iv', offset: -1, circleOffset: -1, suffix: 'm7', function: 'サブドミナント', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: 'V', offset: 1, circleOffset: 1, suffix: '7', function: 'ドミナント', isMajor: true, color: DOMINANT_COLOR, isDiatonic: true },
            { roman: '♭VI', offset: -4, circleOffset: -1, suffix: 'Maj7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: 'vii', offset: 5, circleOffset: 5, suffix: 'dim7', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR, isDiatonic: true },
            // ノンダイアトニックだが実用的
            { roman: '♭II', offset: -5, circleOffset: -5, suffix: '7', function: '裏コード（V7代理）', isMajor: true, color: DOMINANT_COLOR, isDiatonic: false }
        ];

        // メロディックマイナーのダイアトニックコード
        const minorDegreesMelodic = [
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm(Maj7)', function: 'トニック', isMajor: false, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'ii', offset: 2, circleOffset: 2, suffix: 'm7', function: 'サブドミナント', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: '♭III', offset: -3, circleOffset: 0, suffix: 'Maj7(♯5)', function: 'トニック（代理）', isMajor: true, color: TONIC_COLOR, isDiatonic: true },
            { roman: 'IV', offset: -1, circleOffset: -1, suffix: '7', function: 'サブドミナント', isMajor: true, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: 'V', offset: 1, circleOffset: 1, suffix: '7', function: 'ドミナント', isMajor: true, color: DOMINANT_COLOR, isDiatonic: true },
            { roman: 'vi', offset: 3, circleOffset: 3, suffix: 'm7(♭5)', function: 'サブドミナント（代理）', isMajor: false, color: SUBDOMINANT_COLOR, isDiatonic: true },
            { roman: 'vii', offset: 5, circleOffset: 5, suffix: 'm7(♭5)', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR, isDiatonic: true },
            // ノンダイアトニックだが実用的
            { roman: '♭II', offset: -5, circleOffset: -5, suffix: '7', function: '裏コード（V7代理）', isMajor: true, color: DOMINANT_COLOR, isDiatonic: false }
        ];

        // 後方互換性のため（進行表示用）
        const minorDegrees = [
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm7', function: 'トニック', isMajor: false, color: TONIC_COLOR },
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm(Maj7)', function: 'トニック', isMajor: false, color: TONIC_COLOR },
            { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm6', function: 'トニック', isMajor: false, color: TONIC_COLOR },
            { roman: 'ii', offset: 2, circleOffset: 2, suffix: 'm7(♭5)', function: 'サブドミナント（代理）', isMajor: false, color: SUBDOMINANT_COLOR },
            { roman: '♭III', offset: -3, circleOffset: 0, suffix: 'Maj7', function: 'トニック（代理）', isMajor: true, color: TONIC_COLOR },
            { roman: 'iv', offset: -1, circleOffset: -1, suffix: 'm7', function: 'サブドミナント', isMajor: false, color: SUBDOMINANT_COLOR },
            { roman: 'V', offset: 1, circleOffset: 1, suffix: '7', function: 'ドミナント（ハーモニック）', isMajor: true, color: DOMINANT_COLOR },
            { roman: 'v', offset: 1, circleOffset: 1, suffix: 'm7', function: 'ドミナント（ナチュラル）', isMajor: false, color: DOMINANT_COLOR },
            { roman: '♭VI', offset: -4, circleOffset: -1, suffix: 'Maj7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR },
            { roman: '♭VI', offset: -4, circleOffset: -1, suffix: '7', function: 'サブドミナント（ブルース）', isMajor: true, color: SUBDOMINANT_COLOR },
            { roman: '♭V', offset: -6, circleOffset: -6, suffix: '7', function: 'パッシング・ドミナント', isMajor: true, color: DOMINANT_COLOR },
            { roman: 'vii', offset: 5, circleOffset: 5, suffix: 'dim7', function: 'ドミナント（代理）', isMajor: false, color: DOMINANT_COLOR },
            { roman: '♭VII', offset: -2, circleOffset: 1, suffix: '7', function: 'サブドミナント（代理）', isMajor: true, color: SUBDOMINANT_COLOR },
            { roman: 'I', offset: 0, circleOffset: 0, suffix: '7', function: 'セカンダリー・ドミナント (V7/IV)', isMajor: true, color: DOMINANT_COLOR }
        ];

        // よくあるコード進行のプリセット（メジャー・キー）
        const majorProgressions = {
            '251': {
                name: 'ツーファイブワン (II-V-I)',
                degrees: ['iim7', 'V7', 'IMaj7'],
                description: 'ジャズで最も重要な進行。IIm7でサブドミナントの響き、V7でドミナントの緊張、IMaj7で解決する。この進行をマスターすることがジャズの第一歩。V7は裏コードの♭II7に交換可能。'
            },
            'blues12': {
                name: '12小節ブルース',
                degrees: ['I7', 'I7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'IV7', 'I7', 'V7'],
                description: 'ロック、ジャズ、R&Bの基本。全てのコードが7thなのがブルースの特徴。2小節目にIV7に行くのが普通（クイック・チェンジ）。11-12小節目には「ターンアラウンド」という定型の進行が入ることが多い。',
                isBlues: true
            },
            'blues_jazz': {
                name: 'ジャズ・ブルース',
                degrees: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'vim7', 'iim7', 'V7', 'I7', 'V7'],
                description: '基本ブルースにジャズ要素を追加。8小節目のVIm7と9-10小節目のII-Vがジャズらしい響きを生む。',
                isBlues: true
            },
            'blues_quick': {
                name: 'クイック・チェンジ・ブルース',
                degrees: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'IV7', 'I7', 'V7'],
                description: '2小節目ですぐIV7に移動する進行。より動きが活発で、ブルースのスタンダードなバリエーション。それぞれのコード上で4度を入れるのもブルース言語としては普通。11-12小節目に「I7-IV7-I7-V7」などをターンアラウンドとして使うことも多い。',
                isBlues: true
            },
            'blues8': {
                name: '8小節ブルース',
                degrees: ['I7', 'V7', 'IV7', 'IV7', 'I7', 'V7', 'I7/IV7', 'I7/V7'],
                description: '「Key to the Highway」などで有名な8小節形式。ゴスペルなどでも多い進行。12小節より短くコンパクト。2小節目でいきなりV7に行くのが特徴。7-8小節目は2拍ずつI7-IV7-I7-V7と動くターンアラウンドが定番。古いカントリーブルースやジャンプブルースでよく使われる。',
                isBlues: true
            },
            '1645_50s': {
                name: '50s進行 (I-VI-IV-V)',
                degrees: ['IMaj7', 'vim7', 'IVMaj7', 'V7'],
                description: '1950年代のドゥーワップやオールディーズで多用。「Stand By Me」などの名曲で使用。郷愁を誘う優しい響き。'
            },
            '1564': {
                name: '王道進行 (I-V-VI-IV)',
                degrees: ['IMaj7', 'V7', 'vim7', 'IVMaj7'],
                description: 'J-POPで最も使われる進行。「カノン進行」とも。感動的でエモーショナルな響きが特徴。'
            },
            '4516': {
                name: '王道進行バリエ (IV-V-I-VI)',
                degrees: ['IVMaj7', 'V7', 'IMaj7', 'vim7'],
                description: '王道進行を別の位置から始めたもの。サビの頭などでよく使われ、盛り上がりを演出する。'
            },
            '4m-4-1-I7': {
                name: 'サブドミナント・マイナー進行',
                degrees: ['IVMaj7', 'IVm7', 'IMaj7', 'I7'],
                description: 'IV→IVm→Iの流れが切ない響きを生む。最後のI7は次のコードへのセカンダリー・ドミナント。ゴスペルやモダン・ブルース以前でよく見られる進行。ゴスペル、ソウルではIVはトライアドが多く、IVm6になることも多い。また、サブドミナントマイナーの代わりに#IVdim7を使うバリエーションもある。'
            },
            '1451': {
                name: 'スリーコード (I-IV-V-I)',
                degrees: ['IMaj7', 'IVMaj7', 'V7', 'IMaj7'],
                description: '音楽の基本中の基本。トニック→サブドミナント→ドミナント→トニックの流れ。すべての進行の原型。トライアドで演奏されることも多い。'
            },
            '1625': {
                name: '1625進行 (I-VI-II-V)',
                degrees: ['IMaj7', 'vim7', 'iim7', 'V7'],
                description: 'ジャズスタンダードの定番。「循環コード」とも呼ばれ、曲の終わりやターンアラウンドで使用。'
            },
            '4536': {
                name: 'IV-V-III-VI',
                degrees: ['IVMaj7', 'V7', 'iiim7', 'vim7'],
                description: 'J-POPやアニソンで人気。「小室進行」とも。明るく力強い響きが特徴。'
            },
            '1345': {
                name: 'I-III-IV-V',
                degrees: ['IMaj7', 'iiim7', 'IVMaj7', 'V7'],
                description: ''
            },
            '1b741': {
                name: 'I-bVII-IV-I',
                degrees: ['IMaj7', 'bVII7', 'IVMaj7', 'IMaj7'],
                description: 'ロックで多用されるモーダルな進行。♭VIIがミクソリディアンの響きを持ち込み、開放的な雰囲気を作る。'
            }
        };

        // よくあるコード進行のプリセット（マイナー・キー）
        const minorProgressions = {
            'm251': {
                name: 'マイナー・ツーファイブワン (IIm7♭5-V7-Im)',
                degrees: ['iim7(♭5)', 'V7', 'im7'],
                description: 'マイナーキーの基本進行。IIm7♭5の暗い響きからV7の緊張、Im7への解決。ハーモニックマイナーのV7が決め手。'
            },
            'mblues': {
                name: 'マイナー・ブルース (Im-IVm-V7-Im)',
                degrees: ['im7', 'ivm7', 'V7', 'im7'],
                description: 'シンプルなマイナーブルースの基本形。メジャーブルースより哀愁のある響き。'
            },
            'mblues12': {
                name: '12小節マイナー・ブルース',
                degrees: ['im7', 'im7', 'im7', 'im7', 'ivm7', 'ivm7', 'im7', 'im7', 'V7', 'ivm7', 'im7', 'V7'],
                description: 'マイナーキーの12小節ブルース。メジャーと比べて暗く深みのある表現が可能。',
                isBlues: true
            },
            'thrill': {
                name: 'Thrill is Gone (♭VI7-♭V7-Im)',
                degrees: ['♭VI7', '♭V7', 'im7'],
                description: 'B.B.キングの名曲で有名な進行。♭VI7から半音下がって♭V7、そしてImへ。独特の哀愁とドラマティックな響き。'
            },
            'cliche': {
                name: 'マイナー・ライン・クリシェ',
                degrees: ['im7', 'im(Maj7)', 'im7', 'im6'],
                description: 'トニックのルートを保持しながら内声が半音で下行する技法。映画音楽やジャズバラードで多用。神秘的な雰囲気。'
            },
            'secondary': {
                name: 'セカンダリー・ドミナント進行',
                degrees: ['im7', 'I7', 'ivm7', 'V7'],
                description: 'I7はIVへのセカンダリードミナント（V7/IV）。次のコードへ強く進む力を生む技法。'
            },
            'harmonic': {
                name: 'ハーモニック・マイナー進行',
                degrees: ['im7', 'bVIMaj7', 'V7', 'im7'],
                description: '♭VIの明るさとV7のテンションが対比を生む。クラシカルで劇的な響き。'
            },
            'relative': {
                name: 'リラティブ・メジャーへの進行',
                degrees: ['iim7(♭5)', 'V7', 'im7', 'bIIIMaj7'],
                description: '最後の♭IIIはマイナーキーの平行調。マイナーからメジャーの明るさへ自然に移行。'
            },
            'dim': {
                name: 'ディミニッシュ・アプローチ',
                degrees: ['im7', 'VIIdim7', 'V7', 'im7'],
                description: 'VIIdim7はV7の代理で、同じトライトーンを持つ。ルートが半音上がるスムーズな動き。'
            },
            'natural': {
                name: 'ナチュラルマイナー系進行',
                degrees: ['im7', 'ivm7', 'bVII7', 'bIIIMaj7'],
                description: 'エオリアン（ナチュラルマイナー）スケールのコードのみを使用。モーダルで開放的な響き。'
            },
            'prep251': {
                name: 'ツーファイブへの準備',
                degrees: ['im7', 'bVIMaj7', 'iim7(♭5)', 'V7'],
                description: '♭VIから自然にII-Vへ流れる進行。♭VIの明るさがアクセントになる。'
            },
            'royal_minor': {
                name: '王道進行マイナー版',
                degrees: ['bVIMaj7', 'bVII7', 'im7', 'V7'],
                description: 'メジャーの王道進行をマイナーに移植。♭VI→♭VII→Imの流れがエモーショナル。'
            }
        };

        const svg = document.getElementById('circle-of-fifths');
        const centerX = 350;
        const centerY = 350;
        const outerRadius = 280;
        const innerMajorRadius = 200;
        const innerMinorRadius = 200;
        const centerMinorRadius = 120;
        const degreeCircleRadius = 25;
        const anglePerSegment = 30;

        // 現在の選択状態
        let currentKey = null;
        let currentType = null;
        let currentKeyIndex = null;

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function createSegmentPath(cx, cy, innerR, outerR, startAngle, endAngle) {
            const startOuter = polarToCartesian(cx, cy, outerR, startAngle);
            const endOuter = polarToCartesian(cx, cy, outerR, endAngle);
            const startInner = polarToCartesian(cx, cy, innerR, endAngle);
            const endInner = polarToCartesian(cx, cy, innerR, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

            return [
                "M", startOuter.x, startOuter.y,
                "A", outerR, outerR, 0, largeArcFlag, 1, endOuter.x, endOuter.y,
                "L", startInner.x, startInner.y,
                "A", innerR, innerR, 0, largeArcFlag, 0, endInner.x, endInner.y,
                "Z"
            ].join(" ");
        }

        // 各セグメントを描画
        keys.forEach((key, index) => {
            const startAngle = index * anglePerSegment;
            const endAngle = startAngle + anglePerSegment;
            const midAngle = startAngle + anglePerSegment / 2;

            // 長調セグメント
            const majorPath = createSegmentPath(centerX, centerY, innerMajorRadius, outerRadius, startAngle, endAngle);
            const majorSegment = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            majorSegment.setAttribute('d', majorPath);
            majorSegment.setAttribute('fill', '#388e3c');
            majorSegment.setAttribute('stroke', 'white');
            majorSegment.setAttribute('stroke-width', '2');
            majorSegment.classList.add('segment-major');
            majorSegment.setAttribute('data-key', key.major);
            majorSegment.setAttribute('data-type', 'major');
            majorSegment.setAttribute('data-index', index);
            svg.appendChild(majorSegment);

            // 長調のテキスト
            const majorTextPos = polarToCartesian(centerX, centerY, (outerRadius + innerMajorRadius) / 2, midAngle);
            const majorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            majorText.setAttribute('x', majorTextPos.x);
            majorText.setAttribute('y', majorTextPos.y + 6);
            majorText.setAttribute('text-anchor', 'middle');
            majorText.setAttribute('dominant-baseline', 'middle');
            majorText.setAttribute('font-size', '22');
            majorText.setAttribute('font-weight', '600');
            majorText.setAttribute('fill', 'white');
            majorText.setAttribute('style', 'text-rendering: optimizeLegibility;');
            majorText.textContent = key.major;
            svg.appendChild(majorText);

            // 短調セグメント
            const minorPath = createSegmentPath(centerX, centerY, centerMinorRadius, innerMinorRadius, startAngle, endAngle);
            const minorSegment = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            minorSegment.setAttribute('d', minorPath);
            minorSegment.setAttribute('fill', '#81c784');
            minorSegment.setAttribute('stroke', 'white');
            minorSegment.setAttribute('stroke-width', '2');
            minorSegment.classList.add('segment-minor');
            minorSegment.setAttribute('data-key', key.minor);
            minorSegment.setAttribute('data-type', 'minor');
            minorSegment.setAttribute('data-index', index);
            svg.appendChild(minorSegment);

            // 短調のテキスト（外側に配置）
            const minorTextPos = polarToCartesian(centerX, centerY, (innerMinorRadius + centerMinorRadius) / 2 + 20, midAngle);
            const minorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            minorText.setAttribute('x', minorTextPos.x);
            minorText.setAttribute('y', minorTextPos.y);
            minorText.setAttribute('text-anchor', 'middle');
            minorText.setAttribute('dominant-baseline', 'middle');
            minorText.setAttribute('font-size', '16');
            minorText.setAttribute('font-weight', '500');
            minorText.setAttribute('fill', '#1b5e20');
            minorText.setAttribute('style', 'text-rendering: optimizeLegibility;');
            minorText.textContent = key.minor;
            svg.appendChild(minorText);

            // クリックイベント
            majorSegment.addEventListener('click', () => selectKey(key, 'major', majorSegment, index));
            minorSegment.addEventListener('click', () => selectKey(key, 'minor', minorSegment, index));
        });

        // 中央の白い円
        const centerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        centerCircle.setAttribute('cx', centerX);
        centerCircle.setAttribute('cy', centerY);
        centerCircle.setAttribute('r', centerMinorRadius);
        centerCircle.setAttribute('fill', 'white');
        svg.appendChild(centerCircle);

        // 中央のタイトルテキスト
        const titleText1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        titleText1.setAttribute('x', centerX);
        titleText1.setAttribute('y', centerY - 50);
        titleText1.setAttribute('text-anchor', 'middle');
        titleText1.setAttribute('dominant-baseline', 'middle');
        titleText1.setAttribute('font-size', '24');
        titleText1.setAttribute('font-weight', '700');
        titleText1.setAttribute('fill', '#2e7d32');
        titleText1.setAttribute('style', 'text-rendering: optimizeLegibility;');
        titleText1.textContent = '五度圏';
        svg.appendChild(titleText1);

        const titleText2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        titleText2.setAttribute('x', centerX);
        titleText2.setAttribute('y', centerY - 30);
        titleText2.setAttribute('text-anchor', 'middle');
        titleText2.setAttribute('dominant-baseline', 'middle');
        titleText2.setAttribute('font-size', '16');
        titleText2.setAttribute('font-weight', '400');
        titleText2.setAttribute('fill', '#66bb6a');
        titleText2.setAttribute('style', 'text-rendering: optimizeLegibility;');
        titleText2.textContent = 'Circle of Fifths';
        svg.appendChild(titleText2);

        // スケールモード切り替えボタン（マイナーキー用）
        let currentScaleMode = 'natural'; // 'natural', 'harmonic', 'melodic'

        // メロディックマイナーボタン
        const melodicBtn = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        melodicBtn.setAttribute('x', centerX - 55);
        melodicBtn.setAttribute('y', centerY);
        melodicBtn.setAttribute('width', 50);
        melodicBtn.setAttribute('height', 30);
        melodicBtn.setAttribute('rx', '5');
        melodicBtn.setAttribute('fill', 'white');
        melodicBtn.setAttribute('stroke', '#e91e63');
        melodicBtn.setAttribute('stroke-width', '2');
        melodicBtn.setAttribute('cursor', 'pointer');
        melodicBtn.setAttribute('id', 'melodic-btn');
        svg.appendChild(melodicBtn);

        const melodicText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        melodicText.setAttribute('x', centerX - 30);
        melodicText.setAttribute('y', centerY + 19);
        melodicText.setAttribute('text-anchor', 'middle');
        melodicText.setAttribute('font-size', '8');
        melodicText.setAttribute('font-weight', '600');
        melodicText.setAttribute('fill', '#e91e63');
        melodicText.setAttribute('cursor', 'pointer');
        melodicText.setAttribute('id', 'melodic-text');
        melodicText.textContent = 'Melodic';
        svg.appendChild(melodicText);

        // ハーモニックマイナーボタン
        const harmonicBtn = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        harmonicBtn.setAttribute('x', centerX + 5);
        harmonicBtn.setAttribute('y', centerY);
        harmonicBtn.setAttribute('width', 50);
        harmonicBtn.setAttribute('height', 30);
        harmonicBtn.setAttribute('rx', '5');
        harmonicBtn.setAttribute('fill', 'white');
        harmonicBtn.setAttribute('stroke', '#9c27b0');
        harmonicBtn.setAttribute('stroke-width', '2');
        harmonicBtn.setAttribute('cursor', 'pointer');
        harmonicBtn.setAttribute('id', 'harmonic-btn');
        svg.appendChild(harmonicBtn);

        const harmonicText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        harmonicText.setAttribute('x', centerX + 30);
        harmonicText.setAttribute('y', centerY + 19);
        harmonicText.setAttribute('text-anchor', 'middle');
        harmonicText.setAttribute('font-size', '8');
        harmonicText.setAttribute('font-weight', '600');
        harmonicText.setAttribute('fill', '#9c27b0');
        harmonicText.setAttribute('cursor', 'pointer');
        harmonicText.setAttribute('id', 'harmonic-text');
        harmonicText.textContent = 'Harmonic';
        svg.appendChild(harmonicText);

        // ボタンクリックイベント
        function updateScaleModeButtons() {
            const mBtn = document.getElementById('melodic-btn');
            const mText = document.getElementById('melodic-text');
            const hBtn = document.getElementById('harmonic-btn');
            const hText = document.getElementById('harmonic-text');

            if (currentScaleMode === 'melodic') {
                mBtn.setAttribute('fill', '#e91e63');
                mText.setAttribute('fill', 'white');
            } else {
                mBtn.setAttribute('fill', 'white');
                mText.setAttribute('fill', '#e91e63');
            }

            if (currentScaleMode === 'harmonic') {
                hBtn.setAttribute('fill', '#9c27b0');
                hText.setAttribute('fill', 'white');
            } else {
                hBtn.setAttribute('fill', 'white');
                hText.setAttribute('fill', '#9c27b0');
            }
        }

        melodicBtn.addEventListener('click', () => {
            if (currentType !== 'minor') return;
            currentScaleMode = currentScaleMode === 'melodic' ? 'natural' : 'melodic';
            updateScaleModeButtons();
            if (currentKey) {
                updateDiatonicTable(currentKey, currentType, currentKeyIndex);
            }
        });

        melodicText.addEventListener('click', () => {
            if (currentType !== 'minor') return;
            currentScaleMode = currentScaleMode === 'melodic' ? 'natural' : 'melodic';
            updateScaleModeButtons();
            if (currentKey) {
                updateDiatonicTable(currentKey, currentType, currentKeyIndex);
            }
        });

        harmonicBtn.addEventListener('click', () => {
            if (currentType !== 'minor') return;
            currentScaleMode = currentScaleMode === 'harmonic' ? 'natural' : 'harmonic';
            updateScaleModeButtons();
            if (currentKey) {
                updateDiatonicTable(currentKey, currentType, currentKeyIndex);
            }
        });

        harmonicText.addEventListener('click', () => {
            if (currentType !== 'minor') return;
            currentScaleMode = currentScaleMode === 'harmonic' ? 'natural' : 'harmonic';
            updateScaleModeButtons();
            if (currentKey) {
                updateDiatonicTable(currentKey, currentType, currentKeyIndex);
            }
        });

        // キー選択
        let selectedElement = null;
        let degreeElements = [];

        function selectKey(key, type, element, index) {
            // 前回のタイプを保存（メジャー/マイナーの切り替え判定用）
            const previousType = currentType;

            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }

            degreeElements.forEach(el => el.remove());
            degreeElements = [];

            element.classList.add('selected');
            selectedElement = element;

            currentKey = key;
            currentType = type;
            currentKeyIndex = index;

            const selectedIndex = parseInt(element.getAttribute('data-index'));

            // 五度圏上に表示するコード（dim7と裏コードを含む）
            // メジャーキー用
            const majorCircleChords = [
                { roman: 'I', offset: 0, suffix: 'Maj7', isMajor: true, color: TONIC_COLOR },
                { roman: 'ii', offset: 2, suffix: 'm7', isMajor: false, color: SUBDOMINANT_COLOR },
                { roman: 'iii', offset: 4, suffix: 'm7', isMajor: false, color: TONIC_COLOR },
                { roman: 'IV', offset: -1, suffix: 'Maj7', isMajor: true, color: SUBDOMINANT_COLOR },
                { roman: 'V', offset: 1, suffix: '7', isMajor: true, color: DOMINANT_COLOR },
                { roman: 'vi', offset: 3, suffix: 'm7', isMajor: false, color: TONIC_COLOR },
                { roman: 'vii', offset: 5, suffix: 'dim7', isMajor: false, color: DOMINANT_COLOR },
                { roman: '♭II', offset: -5, suffix: '7', isMajor: true, color: DOMINANT_COLOR, isSubstitute: true }
            ];

            // マイナーキー用
            const minorCircleChords = [
                { roman: 'i', offset: 0, circleOffset: 0, suffix: 'm7', isMajor: false, color: TONIC_COLOR },
                { roman: 'ii', offset: 2, circleOffset: 2, suffix: 'm7(♭5)', isMajor: false, color: SUBDOMINANT_COLOR },
                { roman: '♭III', offset: -3, circleOffset: 0, suffix: 'Maj7', isMajor: true, color: TONIC_COLOR },
                { roman: 'iv', offset: -1, circleOffset: -1, suffix: 'm7', isMajor: false, color: SUBDOMINANT_COLOR },
                { roman: 'V', offset: 1, circleOffset: 1, suffix: '7', isMajor: true, color: DOMINANT_COLOR },
                { roman: 'v', offset: 1, circleOffset: 1, suffix: 'm7', isMajor: false, color: DOMINANT_COLOR },
                { roman: '♭VI', offset: -4, circleOffset: -1, suffix: 'Maj7', isMajor: true, color: SUBDOMINANT_COLOR },
                { roman: '♭VII', offset: -2, circleOffset: 1, suffix: '7', isMajor: true, color: SUBDOMINANT_COLOR },
                { roman: 'vii', offset: 5, circleOffset: 5, suffix: 'dim7', isMajor: false, color: DOMINANT_COLOR },
                { roman: '♭II', offset: -5, circleOffset: -5, suffix: '7', isMajor: true, color: DOMINANT_COLOR, isSubstitute: true }
            ];

            const degreesToShow = type === 'major' ? majorCircleChords : minorCircleChords;

            degreesToShow.forEach((degree) => {
                // 五度圏表示用はcircleOffsetを使用（なければoffset）
                const displayOffset = degree.circleOffset !== undefined ? degree.circleOffset : degree.offset;
                let targetIndex = (selectedIndex + displayOffset + 12) % 12;

                if (type === 'major' && !degree.isMajor) {
                    targetIndex = (targetIndex + 9) % 12;
                }

                const startAngle = targetIndex * anglePerSegment;
                const midAngle = startAngle + anglePerSegment / 2;

                let displayRadius;
                if (degree.isSubstitute) {
                    // 裏コードは外側に特別表示
                    displayRadius = outerRadius + 30;
                } else if (degree.isMajor) {
                    displayRadius = outerRadius + 30;
                } else {
                    // マイナーコードのディグリーは中心寄りに配置
                    displayRadius = (innerMinorRadius + centerMinorRadius) / 2 - 5;
                }

                const pos = polarToCartesian(centerX, centerY, displayRadius, midAngle);

                const degreeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                degreeGroup.classList.add('degree-circle');

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', degree.isMajor ? pos.y : pos.y + 15);
                const circleRadius = degree.isMajor ? degreeCircleRadius : 16;
                circle.setAttribute('r', circleRadius);

                // 裏コードもドミナント系なので同じ色
                circle.setAttribute('fill', degree.color);
                circle.setAttribute('fill-opacity', degree.isMajor ? '1' : '0.8');
                circle.setAttribute('stroke', 'white');
                circle.setAttribute('stroke-width', '2');

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', pos.x);
                const textY = degree.isMajor ? pos.y + 5 : pos.y + 15 + 4;
                text.setAttribute('y', textY);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                const fontSize = degree.isMajor ? '14' : '10';
                text.setAttribute('font-size', fontSize);
                text.setAttribute('font-weight', '600');
                // 裏コードとドミナント系は白文字
                if (degree.isSubstitute || degree.color === DOMINANT_COLOR) {
                    text.setAttribute('fill', 'white');
                } else {
                    text.setAttribute('fill', '#333');
                }
                text.setAttribute('style', 'text-rendering: optimizeLegibility;');
                text.textContent = degree.roman;

                degreeGroup.appendChild(circle);
                degreeGroup.appendChild(text);
                svg.appendChild(degreeGroup);

                degreeElements.push(degreeGroup);
            });

            // 情報パネルを更新
            const infoPanel = document.querySelector('.info-panel');
            const keyName = type === 'major' ? key.major : key.minor;
            const keyType = type === 'major' ? '長調' : '短調';

            let accidentals = '';
            if (key.sharps > 0) {
                accidentals = `♯が${key.sharps}個`;
            } else if (key.flats > 0) {
                accidentals = `♭が${key.flats}個`;
            } else {
                accidentals = '調号なし';
            }

            const parallel = type === 'major' ?
                `平行短調: ${key.minor}` :
                `平行長調: ${key.major}`;

            infoPanel.innerHTML = `
                <h2>${keyName} ${keyType}</h2>
                <p><strong>調号:</strong> ${accidentals}</p>
                <p>${parallel}</p>
            `;

            // タイプが変わった場合のみ進行選択をクリア
            const typeChanged = previousType !== null && previousType !== type;
            updateProgressionSelect(typeChanged);
            updateProgressionDisplay();
            updateDiatonicTable(key, type, index);
        }

        // ダイアトニックコード一覧表の更新
        function updateDiatonicTable(key, type, keyIndex) {
            const centerPanel = document.getElementById('center-panel');
            const diatonicTbody = document.getElementById('diatonic-tbody');
            const diatonicTitle = document.getElementById('diatonic-title');

            // 中央パネルを表示
            centerPanel.style.display = 'block';

            // テーブルの内容をクリア
            diatonicTbody.innerHTML = '';

            // スケール名を更新
            let scaleName = '';
            let degreesToShow = [];

            if (type === 'major') {
                scaleName = 'ダイアトニックコード';
                degreesToShow = majorDegrees;
            } else {
                // マイナーキーの場合はスケールモードに応じて切り替え
                if (currentScaleMode === 'harmonic') {
                    scaleName = 'ダイアトニックコード（ハーモニックマイナー）';
                    degreesToShow = minorDegreesHarmonic;
                } else if (currentScaleMode === 'melodic') {
                    scaleName = 'ダイアトニックコード（メロディックマイナー）';
                    degreesToShow = minorDegreesMelodic;
                } else {
                    scaleName = 'ダイアトニックコード（ナチュラルマイナー）';
                    degreesToShow = minorDegreesNatural;
                }
            }

            diatonicTitle.textContent = scaleName;

            // 異名同音判定
            const useSharp = key.sharps > 0;

            // 各コードを表示
            degreesToShow.forEach((degree) => {
                // コード名を計算
                const baseIndex = type === 'minor' ? (keyIndex + 3) % 12 : keyIndex;
                const rootIndex = (baseIndex + degree.offset + 12) % 12;
                const rootNote = getNoteName(rootIndex, useSharp);
                const chordName = rootNote + degree.suffix;

                // 機能のクラス名
                let functionClass = '';
                if (degree.function.includes('トニック')) {
                    functionClass = 'function-tonic';
                } else if (degree.function.includes('サブドミナント')) {
                    functionClass = 'function-subdominant';
                } else if (degree.function.includes('ドミナント') || degree.function.includes('裏コード')) {
                    functionClass = 'function-dominant';
                }

                // ノンダイアトニックの場合はスタイルを変更
                const nonDiatonicStyle = degree.isDiatonic === false ? 'opacity: 0.7; font-style: italic;' : '';
                const nonDiatonicMark = degree.isDiatonic === false ? '※ ' : '';

                // テーブル行を作成
                const tr = document.createElement('tr');
                tr.setAttribute('style', nonDiatonicStyle);
                tr.innerHTML = `
                    <td>${nonDiatonicMark}${degree.roman}${degree.suffix}</td>
                    <td><strong>${chordName}</strong></td>
                    <td class="${functionClass}">${degree.function}</td>
                `;
                diatonicTbody.appendChild(tr);
            });

            // 注釈を追加（ノンダイアトニックコードがある場合）
            const hasNonDiatonic = degreesToShow.some(d => d.isDiatonic === false);
            if (hasNonDiatonic) {
                const noteRow = document.createElement('tr');
                noteRow.innerHTML = `
                    <td colspan="3" style="font-size: 0.8em; color: #888; padding-top: 10px;">
                        ※ ノンダイアトニックだが実用的なコード
                    </td>
                `;
                diatonicTbody.appendChild(noteRow);
            }
        }

        // コード進行セレクトの更新（メジャー/マイナーに応じて）
        function updateProgressionSelect(shouldClear = false) {
            const progressionSelect = document.getElementById('progression-select');
            const currentSelection = progressionSelect.value; // 現在の選択を保存
            const progressions = currentType === 'major' ? majorProgressions : minorProgressions;

            // ドロップダウンを再構築
            progressionSelect.innerHTML = '<option value="">-- 進行を選択してください --</option>';

            Object.keys(progressions).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = progressions[key].name;
                progressionSelect.appendChild(option);
            });

            // タイプが変わらなければ選択を維持
            if (!shouldClear && currentSelection) {
                progressionSelect.value = currentSelection;
            } else {
                // 表示をクリア
                const progressionContent = document.getElementById('progression-content');
                progressionContent.innerHTML = `
                    <div class="placeholder-message">
                        キーとコード進行を選択してください
                    </div>
                `;
            }
        }

        // コード進行パネルの更新
        function updateProgressionDisplay() {
            const progressionSelect = document.getElementById('progression-select');
            const selectedProgression = progressionSelect.value;

            if (!currentKey || !selectedProgression) {
                return;
            }

            const progressions = currentType === 'major' ? majorProgressions : minorProgressions;
            const progression = progressions[selectedProgression];
            const degreesData = currentType === 'major' ? majorDegrees : minorDegrees;

            // キー名から♯系/♭系を判定
            const keyName = currentType === 'major' ? currentKey.major : currentKey.minor;
            const useSharp = !keyName.includes('♭');

            // 単一のディグリーからコード情報を取得するヘルパー関数
            function getChordInfo(degreeRoman) {
                const degreeInfo = degreesData.find(d => (d.roman + d.suffix) === degreeRoman);
                if (!degreeInfo) return null;

                const baseIndex = currentType === 'minor' ? (currentKeyIndex + 3) % 12 : currentKeyIndex;
                const rootIndex = (baseIndex + degreeInfo.offset + 12) % 12;
                const rootNote = getNoteName(rootIndex, useSharp);
                const chordName = rootNote + degreeInfo.suffix;

                return {
                    degree: degreeInfo.roman + degreeInfo.suffix,
                    function: degreeInfo.function,
                    chord: chordName,
                    notes: rootNote,
                    color: degreeInfo.color
                };
            }

            // 進行のディグリーに対応するコード情報を取得（2拍ずつの表記にも対応）
            const chords = progression.degrees.map(degreeRoman => {
                // 「I7/IV7」のような2拍ずつの表記をチェック
                if (degreeRoman.includes('/')) {
                    const parts = degreeRoman.split('/');
                    const chord1 = getChordInfo(parts[0]);
                    const chord2 = getChordInfo(parts[1]);
                    if (!chord1 || !chord2) return null;

                    return {
                        degree: chord1.degree + ' / ' + chord2.degree,
                        function: chord1.function,
                        chord: chord1.chord + ' / ' + chord2.chord,
                        notes: chord1.notes + ' / ' + chord2.notes,
                        color: chord1.color,
                        isSplit: true
                    };
                }

                return getChordInfo(degreeRoman);
            }).filter(c => c !== null);

            const displayKeyName = currentType === 'major' ? currentKey.major : currentKey.minor;

            let tableHTML = `
                <div class="progression-summary">
                    <h3>${progression.name}</h3>
                    <p><strong>キー:</strong> ${displayKeyName}</p>
                </div>
            `;

            // ブルース進行の場合はグリッド表示（8小節または12小節）
            if (progression.isBlues && (chords.length === 12 || chords.length === 8)) {
                tableHTML += `<div class="blues-grid">`;
                chords.forEach((chord, index) => {
                    // 機能に応じた背景色
                    let bgColor = '#f5f5f5';
                    if (chord.function.includes('トニック')) bgColor = '#fff3e0';
                    else if (chord.function.includes('サブドミナント')) bgColor = '#e3f2fd';
                    else if (chord.function.includes('ドミナント')) bgColor = '#ffebee';

                    // 2拍ずつの小節の場合は特別な表示
                    if (chord.isSplit) {
                        tableHTML += `
                            <div class="blues-bar" style="background: linear-gradient(90deg, #fff3e0 50%, #ffebee 50%); font-size: 0.75em;">
                                <span class="blues-bar-number">${index + 1}</span>
                                <div>${chord.degree}</div>
                                <div style="font-size: 0.9em;">${chord.chord}</div>
                                <div style="font-size: 0.7em; color: #888;">2拍ずつ</div>
                            </div>
                        `;
                    } else {
                        tableHTML += `
                            <div class="blues-bar" style="background: ${bgColor};">
                                <span class="blues-bar-number">${index + 1}</span>
                                <div>${chord.degree}</div>
                                <div style="font-size: 0.9em;">${chord.chord}</div>
                            </div>
                        `;
                    }
                });
                tableHTML += `</div>`;
            } else {
                // 通常の進行はテーブル表示
                const chordsString = chords.map(c => c.chord).join(' → ');
                const degreesString = chords.map(c => c.degree).join(' → ');

                tableHTML += `
                    <div style="margin: 10px 0; padding: 10px; background: #fafafa; border-radius: 6px;">
                        <p style="margin: 5px 0; font-size: 0.9em;"><strong>進行:</strong> ${degreesString}</p>
                        <p style="margin: 5px 0; font-size: 0.95em;"><strong>コード:</strong> ${chordsString}</p>
                    </div>

                    <table class="progression-table">
                        <thead>
                            <tr>
                                <th>ディグリー</th>
                                <th>機能</th>
                                <th>コード</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                chords.forEach(chord => {
                    let functionClass = '';
                    if (chord.function.includes('トニック')) functionClass = 'function-tonic';
                    else if (chord.function.includes('サブドミナント')) functionClass = 'function-subdominant';
                    else if (chord.function.includes('ドミナント')) functionClass = 'function-dominant';

                    tableHTML += `
                        <tr>
                            <td>${chord.degree}</td>
                            <td class="${functionClass}">${chord.function}</td>
                            <td><strong>${chord.chord}</strong></td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;
            }

            // 解説を追加
            if (progression.description) {
                tableHTML += `
                    <div class="progression-description">
                        <h4>解説</h4>
                        <p>${progression.description}</p>
                    </div>
                `;
            }

            document.getElementById('progression-content').innerHTML = tableHTML;
        }

        // 進行選択のイベントリスナー
        document.getElementById('progression-select').addEventListener('change', updateProgressionDisplay);

        // モバイル用スクロール検出とドットインジケーター更新
        const mainContainer = document.getElementById('main-container');
        const mobileIndicator = document.getElementById('mobile-indicator');
        const dots = mobileIndicator.querySelectorAll('.dot');
        const dotWrappers = mobileIndicator.querySelectorAll('.dot-wrapper');

        function updateActiveIndicator() {
            const scrollLeft = mainContainer.scrollLeft;
            const containerWidth = mainContainer.clientWidth;
            const panelIndex = Math.round(scrollLeft / containerWidth);

            dots.forEach((dot, index) => {
                if (index === panelIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // スクロールイベントでドット更新
        mainContainer.addEventListener('scroll', updateActiveIndicator);

        // ドットクリックでパネルへスクロール
        dotWrappers.forEach((wrapper) => {
            wrapper.addEventListener('click', () => {
                const panelIndex = parseInt(wrapper.getAttribute('data-panel'));
                const containerWidth = mainContainer.clientWidth;
                mainContainer.scrollTo({
                    left: panelIndex * containerWidth,
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>
</html>
